#!/bin/bash
set -euo pipefail

# TraderX ConfigHub - Install ConfigHub Worker for Auto-Deploy
# Pattern 7: Event-Driven Architecture with Workers

PROJECT=$(bin/proj)
if [ -z "$PROJECT" ]; then
  echo "ERROR: Project not found. Run bin/install-base first."
  exit 1
fi

ENV=$1
if [ -z "$ENV" ]; then
  echo "Usage: bin/setup-worker <environment>"
  echo "  Environments: dev, staging, prod"
  exit 1
fi

SPACE="${PROJECT}-${ENV}"
WORKER_NAME="${PROJECT}-worker-${ENV}"

echo "üöÄ Installing ConfigHub worker for $SPACE..."
echo ""

# Check if kubectl is configured
if ! kubectl cluster-info &>/dev/null; then
  echo "‚ùå Error: kubectl is not configured or cluster is not accessible"
  echo "Please create a Kind cluster first:"
  echo "  kind create cluster --name traderx-test"
  exit 1
fi

# Create confighub namespace in cluster
echo "Creating confighub namespace in cluster..."
kubectl create namespace confighub --dry-run=client -o yaml | kubectl apply -f - 2>&1 | grep -v "unchanged" || true
echo ""

# Check if worker already exists in ConfigHub
if cub worker list --space $SPACE 2>/dev/null | grep -q $WORKER_NAME; then
  echo "‚úÖ Worker '$WORKER_NAME' already exists in ConfigHub"
else
  echo "Creating ConfigHub worker..."
  cub worker create $WORKER_NAME --space $SPACE
  echo ""
fi

# Export worker manifest and apply to Kubernetes
echo "Installing worker to Kubernetes cluster..."
cub worker install $WORKER_NAME \
  --namespace confighub \
  --space $SPACE \
  --include-secret \
  --export > /tmp/worker-manifest.yaml

kubectl apply -f /tmp/worker-manifest.yaml 2>&1 | grep -E "(created|configured)" || true
echo ""

# Wait for worker to connect
echo "Waiting for worker to connect..."
sleep 10

# Check worker status
if cub worker list --space $SPACE 2>/dev/null | grep -q "Ready"; then
  echo "‚úÖ Worker connected!"
  echo ""
  cub worker list --space $SPACE
  echo ""
else
  echo "‚ö†Ô∏è  Worker is connecting... Check status with:"
  echo "  cub worker list --space $SPACE"
  echo ""
fi

# Wait for target to be discovered by worker
echo "Waiting for target to be discovered..."
sleep 5

# Get the discovered target (format: k8s-<worker-name>)
TARGET_SLUG="k8s-${WORKER_NAME}"

echo "Setting targets on all units in $SPACE..."
echo "Target: $TARGET_SLUG"
echo ""

# Set target on all units in the space
cub unit set-target $TARGET_SLUG --where "Space.Slug = '$SPACE'" --space $SPACE
echo ""

echo "‚úÖ ConfigHub worker installed!"
echo ""
echo "The worker will now:"
echo "  ‚Ä¢ Monitor $SPACE for changes"
echo "  ‚Ä¢ Apply units to Kubernetes cluster 'traderx-test'"
echo "  ‚Ä¢ Target: $TARGET_SLUG"
echo ""
echo "View worker logs:"
echo "  kubectl logs -n confighub -l confighub-worker=$WORKER_NAME --follow"
echo ""
echo "Next steps:"
echo "  bin/ordered-apply $ENV    # Deploy all services"
echo ""