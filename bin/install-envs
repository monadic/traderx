#!/bin/bash
set -euo pipefail

# TraderX ConfigHub - Environment Hierarchy Setup
# Pattern 2: Space Hierarchy (base ‚Üí dev ‚Üí staging ‚Üí prod)

PROJECT=$(bin/proj)
if [ -z "$PROJECT" ]; then
  echo "ERROR: Project not found. Run bin/install-base first."
  exit 1
fi

echo "üöÄ Creating environment hierarchy for $PROJECT..."

# Create dev environment (cloned from base)
echo "Creating dev environment..."
cub space create ${PROJECT}-dev \
  --label project=$PROJECT \
  --label environment=dev

# Clone units from base to dev with upstream relationship
cub unit create --dest-space ${PROJECT}-dev \
  --space ${PROJECT}-base \
  --filter ${PROJECT}-filters/all \
  --label targetable=true \
  --label environment=dev

# Create staging environment (cloned from dev)
echo "Creating staging environment..."
cub space create ${PROJECT}-staging \
  --label project=$PROJECT \
  --label environment=staging

# Clone units from dev to staging with upstream relationship
cub unit create --dest-space ${PROJECT}-staging \
  --space ${PROJECT}-dev \
  --filter ${PROJECT}-filters/all \
  --label targetable=true \
  --label environment=staging

# Create production environment (cloned from staging)
echo "Creating production environment..."
cub space create ${PROJECT}-prod \
  --label project=$PROJECT \
  --label environment=prod

# Clone units from staging to prod with upstream relationship
cub unit create --dest-space ${PROJECT}-prod \
  --space ${PROJECT}-staging \
  --filter ${PROJECT}-filters/all \
  --label targetable=true \
  --label environment=prod

echo "‚úÖ Environment hierarchy created successfully!"
echo ""

# Create links for dependency management in each environment (ConfigHub canonical pattern)
echo "üîó Creating dependency links in all environments..."
if [ -x "bin/create-links" ]; then
  echo ""
  echo "Creating links in dev environment..."
  bin/create-links dev
  echo ""
  echo "Creating links in staging environment..."
  bin/create-links staging
  echo ""
  echo "Creating links in prod environment..."
  bin/create-links prod
else
  echo "‚ö†Ô∏è  bin/create-links not found or not executable"
  echo "   Links enable ConfigHub to manage dependencies automatically"
  echo "   Run: chmod +x bin/create-links && bin/create-links <env>"
fi
echo ""

echo "Hierarchy:"
echo "  ${PROJECT}-base"
echo "    ‚îî‚îÄ‚îÄ ${PROJECT}-dev (with 20 dependency links)"
echo "        ‚îî‚îÄ‚îÄ ${PROJECT}-staging (with 20 dependency links)"
echo "            ‚îî‚îÄ‚îÄ ${PROJECT}-prod (with 20 dependency links)"
echo ""
echo "Next steps:"
echo "  1. Run: bin/setup-worker dev    # Install ConfigHub worker"
echo "  2. Run: bin/apply-all dev       # Deploy to development"
echo "  3. Run: bin/promote dev staging # Promote to staging"
echo ""
echo "View hierarchy:"
echo "  cub unit tree --node=space --filter ${PROJECT}-filters/all --space '*'"
echo ""
echo "View dependency graph:"
echo "  cub link list --space ${PROJECT}-dev"